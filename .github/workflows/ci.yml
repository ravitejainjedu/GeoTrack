name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  backend:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 9.0.x

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore dependencies
      run: dotnet restore

    - name: Restore tools
      run: dotnet tool restore

    - name: Format Check
      run: dotnet format --verify-no-changes

    - name: Build
      run: dotnet build --no-restore

    - name: Test
      run: dotnet test --no-build --verbosity normal

  frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: src/GeoTrack.UI

    steps:
    - uses: actions/checkout@v4

    # FORENSIC DEBUG: Print exact commit and context
    - name: Debug - Git Info
      run: |
        echo "=== GIT COMMIT INFO ==="
        git rev-parse HEAD
        git log -1 --oneline
        git branch --show-current || echo "detached HEAD"
        git status --porcelain
        echo "=== GITHUB CONTEXT ==="
        echo "github.ref: ${{ github.ref }}"
        echo "github.sha: ${{ github.sha }}"
        echo "github.head_ref: ${{ github.head_ref }}"
        echo "github.base_ref: ${{ github.base_ref }}"

    # FORENSIC DEBUG: Print actual file contents at error lines
    - name: Debug - File Contents at Error Lines
      run: |
        echo "=== DISCOVER FILE STRUCTURE ==="
        ls -la
        find . -maxdepth 4 -name "App.tsx" || true
        find . -maxdepth 4 -name "package.json" || true
        
        echo "=== App.tsx lines 30-50 (errors at 34,43) ==="
        if [ -f src/App.tsx ]; then
          sed -n '30,50p' src/App.tsx
        else
          echo "WARNING: src/App.tsx not found"
        fi

        echo "=== App.tsx lines 60-80 (errors at 65,74) ==="
        if [ -f src/App.tsx ]; then
          sed -n '60,80p' src/App.tsx
        fi

        echo "=== Map.tsx lines 28-35 (error at 31) ==="
        if [ -f src/components/Map.tsx ]; then
          sed -n '28,35p' src/components/Map.tsx
        else
          echo "WARNING: src/components/Map.tsx not found"
        fi

        echo "=== useDeviceHistory.ts lines 78-95 (errors at 81,92) ==="
        if [ -f src/hooks/useDeviceHistory.ts ]; then
          sed -n '78,95p' src/hooks/useDeviceHistory.ts
        else
          echo "WARNING: src/hooks/useDeviceHistory.ts not found"
        fi

    # FORENSIC DEBUG: Check for duplicate files and working directory
    - name: Debug - File Locations
      run: |
        echo "=== CURRENT WORKING DIRECTORY ==="
        pwd
        echo "=== FIND ALL TYPESCRIPT FILES ==="
        find . -name "App.tsx" -o -name "Map.tsx" -o -name "useDeviceHistory.ts"
        echo "=== UI PACKAGE.JSON PATH ==="
        cat package.json | head -n 10

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: src/GeoTrack.UI/package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Lint
      run: npm run lint

    - name: Build
      run: npm run build
